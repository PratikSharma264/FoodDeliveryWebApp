<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Deliveryman Orders</title>
    <style>
      body {
        font-family: monospace;
        background: #f5f5f5;
        padding: 20px;
      }
      #orders {
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        max-width: 900px;
        margin: 0 auto;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        margin: 12px 0;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }
      .meta {
        font-size: 0.9rem;
        color: #555;
        margin-top: 6px;
      }
      .items {
        margin-top: 8px;
      }
      .items li {
        margin-bottom: 4px;
      }
      pre {
        background: #272822;
        color: #f8f8f2;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
      }
      .small {
        font-size: 0.85rem;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1 style="text-align:center">Deliveryman — Incoming Orders</h1>
    <div id="orders"></div>
    <script>
      ;(function () {
        const ordersDiv = document.getElementById('orders')
      
        function log(...args) {
          console.log('[DeliverySocket]', ...args)
        }
      
        function formatUser(u) {
          if (!u) return '—'
          const name = u.username || (u.first_name ? u.first_name + (u.last_name ? ' ' + u.last_name : '') : '—')
          return `${name} (${u.email || 'no-email'})`
        }
      
        function formatDeliveryman(dm) {
          if (!dm) return '—'
          const name = dm.name || (dm.Firstname ? dm.Firstname + (dm.Lastname ? ' ' + dm.Lastname : '') : dm.username || '—')
          const phone = dm.phone ? ` (${dm.phone})` : ''
          return `${name}${phone}`
        }
      
        function restaurantName(rest) {
          if (!rest) return '—'
          return rest.restaurant_name || rest.name || '—'
        }
      
        function renderOrderCard(order) {
          const card = document.createElement('div')
          card.className = 'card'
      
          const id = order.order_id ?? order.id ?? order.order_pk ?? '—'
          const header = document.createElement('div')
          header.innerHTML = `<strong>Order ID:</strong> ${id} <span style="float:right"><strong>Status:</strong> ${order.status ?? '—'}</span>`
          card.appendChild(header)
      
          // User / customer
          const userBlock = document.createElement('div')
          userBlock.className = 'meta'
          const phoneFromCustomer = (order.customer_details && order.customer_details.phone) || order.user?.phone || order.user?.mobile || '—'
          userBlock.innerHTML = `<strong>Customer:</strong> ${formatUser(order.user)} <span class="small"> | Phone: ${phoneFromCustomer}</span>`
          card.appendChild(userBlock)
      
          // Restaurant
          const rest = order.restaurant || {}
          const restBlock = document.createElement('div')
          restBlock.className = 'meta'
          restBlock.innerHTML = `<strong>Restaurant:</strong> ${restaurantName(rest)} <span class="small"> | ${rest.restaurant_address || rest.address || ''}</span>`
          card.appendChild(restBlock)
      
          // Deliveryman (show if present)
          if (order.deliveryman) {
            const dmBlock = document.createElement('div')
            dmBlock.className = 'meta'
            dmBlock.innerHTML = `<strong>Deliveryman:</strong> ${formatDeliveryman(order.deliveryman)}`
            card.appendChild(dmBlock)
          }
      
          // Totals
          const total = document.createElement('div')
          total.className = 'meta'
          const totalDisplay = order.total_price ? 'NPR ' + order.total_price : order.total_display ?? '—'
          total.innerHTML = `<strong>Total:</strong> ${totalDisplay}`
          card.appendChild(total)
      
          // Items
          if (Array.isArray(order.order_items) && order.order_items.length) {
            const itemsTitle = document.createElement('div')
            itemsTitle.style.marginTop = '10px'
            itemsTitle.innerHTML = '<strong>Order Items:</strong>'
            card.appendChild(itemsTitle)
      
            const ul = document.createElement('ul')
            ul.className = 'items'
            order.order_items.forEach((it) => {
              const li = document.createElement('li')
              const name = it.food_item_name || it.name || it.food_item || 'Item'
              const qty = it.quantity ?? it.qty ?? 1
              const price = it.price_at_order ?? it.price ?? null
              li.textContent = `${name} (x${qty})${price ? ' - NPR ' + price : ''}`
              ul.appendChild(li)
            })
            card.appendChild(ul)
          }
      
          // Meta: delivery charge, payment, location
          const meta = document.createElement('div')
          meta.className = 'meta'
          const deliveryCharge = order.delivery_charge_display ?? (order.delivery_charge ? 'NPR ' + order.delivery_charge : '—')
          const payment = order.payment_method ?? '—'
          const lat = order.latitude ?? order.location?.lat ?? '—'
          const long = order.longitude ?? order.location?.long ?? '—'
          meta.innerHTML = `<strong>Delivery Charge:</strong> ${deliveryCharge} <br>
                              <strong>Payment:</strong> ${payment} <br>
                              <strong>Location:</strong> Lat: ${lat}, Long: ${long}`
          card.appendChild(meta)
      
          return card
        }
      
        function normalizedCandidatesFromPayload(payload) {
          // Prefer API shape: data array
          if (payload && Array.isArray(payload.data) && payload.data.length) {
            return payload.data
          }
      
          // Some messages may directly contain an array
          if (Array.isArray(payload) && payload.length) {
            return payload
          }
      
          // older shapes / direct order objects
          if (Array.isArray(payload.orders) && payload.orders.length) {
            return payload.orders
          }
          if (Array.isArray(payload.order) && payload.order.length) {
            return payload.order
          }
          if (payload.order && typeof payload.order === 'object') {
            return [payload.order]
          }
          // one-off delivery notification shape
          if (payload.type === 'delivery_notification' && payload.data) {
            return Array.isArray(payload.data) ? payload.data : payload.data ? [payload.data] : []
          }
          if (payload.type === 'delivery_notification' && payload.order) {
            return [payload.order]
          }
      
          return null
        }
      
        function showPayload(payload) {
          if (!payload) return
          ordersDiv.innerHTML = ''
      
          const candidates = normalizedCandidatesFromPayload(payload)
      
          if (!candidates) {
            const pre = document.createElement('pre')
            pre.textContent = JSON.stringify(payload, null, 4)
            ordersDiv.appendChild(pre)
            return
          }
      
          candidates.forEach((item) => {
            const card = renderOrderCard(item)
            ordersDiv.appendChild(card)
          })
        }
      
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws'
        const url = `${protocol}://${window.location.host}/ws/deliveryman/`
        log('Connecting to', url)
      
        let socket
        try {
          socket = new WebSocket(url)
        } catch (err) {
          log('WebSocket constructor error', err)
          const pre = document.createElement('pre')
          pre.textContent = 'WebSocket constructor error: ' + err
          ordersDiv.appendChild(pre)
          return
        }
      
        socket.onopen = () => {
          log('Connected')
        }
        socket.onclose = (ev) => {
          log('Closed', ev)
        }
        socket.onerror = (err) => {
          log('Error', err)
        }
      
        socket.onmessage = (e) => {
          log('Raw message', e.data)
          let data
          try {
            data = JSON.parse(e.data)
          } catch (err) {
            log('Invalid JSON', err)
            const pre = document.createElement('pre')
            pre.textContent = e.data
            ordersDiv.appendChild(pre)
            return
          }
          log('Parsed message', data)
      
          // Accept multiple types but prefer API-shaped/chat messages
          if (data.type === 'chat' || (data.success && data.data)) {
            showPayload(data)
          } else if (data.type === 'delivery_notification') {
            // delivery_notification may have data or order
            showPayload(data)
          } else {
            // fallback: try to render whatever we got
            showPayload(data)
          }
        }
      
        window._deliverySocket = socket
      })()
    </script>
  </body>
</html>
