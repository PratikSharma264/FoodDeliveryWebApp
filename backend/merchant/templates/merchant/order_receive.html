<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Order Receiver</title>
    <style>
      body {
        font-family: monospace;
        background: #f5f5f5;
        padding: 20px;
      }
      #orders {
        background: #fff;
        padding: 10px;
        border-radius: 8px;
        max-width: 900px;
        margin: 0 auto;
      }
      .card {
        border: 1px solid #ddd;
        padding: 12px;
        margin: 12px 0;
        border-radius: 8px;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }
      pre {
        background: #272822;
        color: #f8f8f2;
        padding: 10px;
        border-radius: 6px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1 style="text-align:center">Order Receiver</h1>
    <div id="orders"></div>
    <script>
      ;(function () {
        const ordersDiv = document.getElementById('orders')
      
        function log(...args) {
          console.log('[OrderSocket]', ...args)
        }
      
        function userNameFromOrder(order) {
          // API: order.user.username or order.user.first_name/last_name, fallback to older keys
          const usr = order.user || {}
          return usr.username || (usr.first_name || '') + (usr.last_name ? ' ' + usr.last_name : '') || order.customer_name || order.username || '—'
        }
      
        function restaurantNameFromOrder(order) {
          // API: order.restaurant.restaurant_name or order.restaurant_name (older)
          if (order.restaurant && typeof order.restaurant === 'object') {
            return order.restaurant.restaurant_name || order.restaurant.name || order.restaurant || '—'
          }
          return order.restaurant_name || order.restaurant || '—'
        }
      
        function renderOrderCard(order) {
          const card = document.createElement('div')
          card.className = 'card'
      
          // ID: API uses order_id, older consumer used id/pk/order_pk
          const id = order.order_id ?? order.id ?? order.order_pk ?? '—'
          const header = document.createElement('div')
          header.innerHTML = `<strong>Order ID:</strong> ${id} <span style="float:right"><strong>Status:</strong> ${order.status ?? '—'}</span>`
          card.appendChild(header)
      
          const cust = document.createElement('div')
          cust.style.marginTop = '8px'
          const customerName = userNameFromOrder(order)
          const restaurantName = restaurantNameFromOrder(order)
          cust.innerHTML = `<strong>Customer:</strong> ${customerName}<br>
                                              <strong>Restaurant:</strong> ${restaurantName}`
          card.appendChild(cust)
      
          const totalDisplay = order.total_display ?? (order.total_price ? 'NPR ' + order.total_price : null)
          const total = document.createElement('div')
          total.style.marginTop = '8px'
          total.innerHTML = `<strong>Total:</strong> ${totalDisplay ?? 'NPR ' + (order.total_price ?? '0.00')}`
          card.appendChild(total)
      
          const deliveryChargeDisplay = order.delivery_charge_display ?? (order.delivery_charge ? 'NPR ' + order.delivery_charge : null)
          const delivery = document.createElement('div')
          delivery.style.marginTop = '4px'
          delivery.innerHTML = `<strong>Delivery Charge:</strong> ${deliveryChargeDisplay ?? 'NPR ' + (order.delivery_charge ?? '0.00')}`
          card.appendChild(delivery)
      
          const payment = document.createElement('div')
          payment.style.marginTop = '8px'
          // API normalizes payment_method to lowercase; keep existing fallback
          payment.innerHTML = `<strong>Payment Method:</strong> ${order.payment_method ?? '—'}`
          card.appendChild(payment)
      
          // location: API uses latitude / longitude as strings or null
          const lat = order.latitude ?? order.location?.lat ?? null
          const long = order.longitude ?? order.location?.long ?? null
          if (lat || long) {
            const loc = document.createElement('div')
            loc.style.marginTop = '4px'
            loc.innerHTML = `<strong>Location:</strong> Lat: ${lat ?? '—'}, Long: ${long ?? '—'}`
            card.appendChild(loc)
          }
      
          // order items: API matches your earlier shape (id, food_item, food_item_name, quantity, price_at_order, total_price)
          if (Array.isArray(order.order_items) && order.order_items.length) {
            const itemsTitle = document.createElement('div')
            itemsTitle.style.marginTop = '10px'
            itemsTitle.innerHTML = '<strong>Order Items:</strong>'
            card.appendChild(itemsTitle)
      
            const ul = document.createElement('ul')
            order.order_items.forEach((it) => {
              const li = document.createElement('li')
              const name = it.food_item_name ?? 'Item ' + (it.food_item ?? '')
              const qty = it.quantity ?? it.qty ?? 1
              const price = it.price_at_order ?? it.price ?? null
              li.textContent = `${name} (x${qty})${price ? ' - NPR ' + price : ''}`
              ul.appendChild(li)
            })
            card.appendChild(ul)
          }
      
          // deliveryman: API returns deliveryman object same as your consumer version
          if (order.deliveryman) {
            const delManDiv = document.createElement('div')
            delManDiv.style.marginTop = '8px'
            // support both deliveryman.name or deliveryman.first/last if available
            const dm = order.deliveryman
            const dmName = dm.name || (dm.Firstname || '') + (dm.Lastname ? ' ' + dm.Lastname : '') || dm.username || '—'
            delManDiv.innerHTML = `<strong>Deliveryman:</strong> ${dmName}${dm.phone ? ' (' + dm.phone + ')' : ''}`
            card.appendChild(delManDiv)
          } else {
            console.log(`Order ID ${id} has no deliveryman assigned`)
          }
      
          // customer details (API provides customer_details)
          if (order.customer_details) {
            const cd = order.customer_details
            const custDiv = document.createElement('div')
            custDiv.style.marginTop = '6px'
            custDiv.innerHTML = `<strong>Customer Contact:</strong> ${cd.email ?? ''}${cd.phone ? ' — ' + cd.phone : ''}`
            card.appendChild(custDiv)
          }
      
          return card
        }
      
        function normalizedCandidatesFromPayload(payload) {
          // Prefer API-style "data"
          if (payload && Array.isArray(payload.data) && payload.data.length) {
            return payload.data
          }
      
          // fallbacks for older shapes the page previously accepted
          if (Array.isArray(payload.orders) && payload.orders.length) {
            return payload.orders
          }
          if (Array.isArray(payload.db_saved) && payload.db_saved.length) {
            return payload.db_saved
          }
          if (Array.isArray(payload.order) && payload.order.length) {
            return payload.order
          }
          if (payload.order && typeof payload.order === 'object') {
            return [payload.order]
          }
          if (Array.isArray(payload) && payload.length) {
            return payload
          }
          return null
        }
      
        function showPayload(payload) {
          if (!payload) return
          ordersDiv.innerHTML = ''
      
          const candidates = normalizedCandidatesFromPayload(payload)
      
          if (!candidates) {
            // nothing recognized — show raw payload prettified
            const pre = document.createElement('pre')
            pre.textContent = JSON.stringify(payload, null, 4)
            ordersDiv.appendChild(pre)
            return
          }
      
          candidates.forEach((item) => {
            const card = renderOrderCard(item)
            ordersDiv.appendChild(card)
          })
        }
      
        const protocol = location.protocol === 'https:' ? 'wss' : 'ws'
        const url = `${protocol}://${window.location.host}/ws/socket-server/`
        log('Connecting to', url)
      
        let socket
        try {
          socket = new WebSocket(url)
        } catch (err) {
          log('WebSocket constructor error', err)
          const pre = document.createElement('pre')
          pre.textContent = 'WebSocket constructor error: ' + err
          ordersDiv.appendChild(pre)
          return
        }
      
        socket.onopen = () => {
          log('Connected')
        }
        socket.onclose = (ev) => {
          log('Closed', ev)
        }
        socket.onerror = (err) => {
          log('Error', err)
        }
      
        socket.onmessage = (e) => {
          log('Raw message', e.data)
          let data
          try {
            data = JSON.parse(e.data)
          } catch (err) {
            log('Invalid JSON', err)
            const pre = document.createElement('pre')
            pre.textContent = e.data
            ordersDiv.appendChild(pre)
            return
          }
          log('Parsed message', data)
          // If message contains `type: 'status'` we can optionally handle it, but showPayload will ignore it.
          // handle only chat/data payloads
          showPayload(data)
        }
      
        window._orderSocket = socket
      })()
    </script>
  </body>
</html>
