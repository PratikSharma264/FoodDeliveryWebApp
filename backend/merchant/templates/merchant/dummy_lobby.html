<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Lobby</title>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <style>
        body {
            font-family: monospace;
            background: #f5f5f5;
            padding: 20px;
        }
        #messages {
            margin-top: 20px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        pre {
            background: #272822;
            color: #f8f8f2;
            padding: 10px;
            border-radius: 6px;
            overflow-x: auto;
        }
        label { display:block; margin-top:8px; }
        textarea { width:100%; height:80px; font-family:monospace; }
        input[type="text"] { width:100%; }
    </style>
</head>
<body>
    <h1>Order Sender</h1>

    <form id="form">

        <label for="userId">User ID:</label><br>
        <input type="text" id="userId" name="user_id" value="15"><br><br>
        
        <label for="restaurantId">Restaurant ID:</label><br>
        <input type="text" id="restaurantId" name="restaurant_id" value="14"><br><br>

        <div id="food-items">
            <label>Food IDs:</label><br>
            <input type="text" name="food_ids[]" placeholder="Enter food ID"><br>
        </div>
        <button type="button" onclick="addFood()">Click to Add Another Food</button><br><br>
        <button type="submit">Submit Order</button>
    </form>

    <h2>Messages (incoming)</h2>
    <div id="messages"></div>


    <script type="text/javascript">

        function addFood() {
            const container = document.getElementById('food-items');
            const input = document.createElement('input');
            input.type = 'text';
            input.name = 'food_ids[]';
            input.placeholder = 'Enter food ID';
            container.appendChild(document.createElement('br'));
            container.appendChild(input);
        }

        let url = `ws://${window.location.host}/ws/socket-server/`;
        const chatSocket = new WebSocket(url);

        chatSocket.onopen = () => console.log("WebSocket opened:", url);

        chatSocket.onmessage = function(e){
            let data = JSON.parse(e.data);
            console.log('Received:', data);

            // Pretty-print whatever we receive
            let messages = document.getElementById('messages');
            let prettyDict = JSON.stringify(data, null, 4);
            messages.insertAdjacentHTML('beforeend', `<pre>${prettyDict}</pre>`);
        }

        let form = document.getElementById('form');
        form.addEventListener('submit', (e)=> {
            e.preventDefault();

            const userId = document.getElementById('userId').value.trim();
            const restaurantId = document.getElementById('restaurantId').value.trim();
            const foodInputs = document.querySelectorAll('input[name="food_ids[]"]');

            const foodIds = Array.from(foodInputs).map(input => input.value.trim()).filter(v => v !== '');
            const orderData = { userId, restaurantId, foodIds };

            console.log("orderData:",orderData);
            let payload = {
                // 'username': username,
                // 'room': 'room',
                'order': orderData
            };

            // Send dictionary to Django consumer
            chatSocket.send(JSON.stringify(payload));

            form.reset();
        })
    </script>
</body>
</html>
